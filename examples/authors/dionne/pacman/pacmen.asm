	.module pacmen
_mrpacmask
	;    	[..][..] [..][..] [..][..] [..][..] [..][..] [..][..] [..][..] [..][..]
	.quat	33333333 33333333 33333333 33333333 33300033 33300033 33300033 33300033 ;1
	.quat	33333333 33300033 33300033 33300033 33000003 33000003 33000003 33000003 ;2
	.quat	33023203 33000003 33000003 33000003 30000000 30000000 30000000 30000000 ;3
	.quat	30023200 30000000 30000000 30000000 30000000 30000000 30000000 30000000 ;4
	.quat	30003000 30000000 30000000 30000000 30003000 30000000 30000000 30000000 ;5
	.quat	30000000 30000000 30000000 30000000 30023200 30000000 30000000 30000000 ;6
	.quat	30000000 30000000 30000000 30000000 33023203 33000003 33000003 33000003 ;7
	.quat	33000003 33000003 33000003 33000003 33333333 33300033 33300033 33300033 ;8
	.quat	33300033 33300033 33300033 33300033 33333333 33333333 33333333 33333333 ;9
	;    	[..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..]
	.quat	333000033333 333300003333 333330000333 333333000033 330000333333 333000033333 333300003333 333330000333 ;1
	.quat	330000003333 333000000333 333300000033 333330000003 300000033333 330000003333 333000000333 333300000033 ;2
	.quat	332200000333 330000000033 333000000003 333300000000 000002233333 300000000333 330000000033 333000000003 ;3
	.quat	333330000333 330000000033 333000000003 333300000000 000033333333 300000000333 330000000033 333000000003 ;4
	.quat	332200000333 330000000033 333000000003 333300000000 000002233333 300000000333 330000000033 333000000003 ;5
	.quat	330000003333 333000000333 333300000033 333330000003 300000033333 330000003333 333000000333 333300000033 ;6
	.quat	333000033333 333300003333 333330000333 333333000033 330000333333 333000033333 333300003333 333330000333 ;7

_mrpacbits
	;    	[..][..] [..][..] [..][..] [..][..] [..][..] [..][..] [..][..] [..][..]
	.quat	00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 ;1
	.quat	00000000 00010100 00011100 00010100 00011100 00011100 00011100 00011100 ;2
	.quat	00100010 00110110 00111110 00110110 00111110 00111110 00111110 00111110 ;3
	.quat	01100011 01110111 01111111 01110111 01111111 01111111 01111111 01111111 ;4
	.quat	01110111 01111111 01111111 01111111 01110111 01111111 01111111 01111111 ;5
	.quat	01111111 01111111 01111111 01111111 01100011 01110111 01111111 01110111 ;6
	.quat	00111110 00111110 00111110 00111110 00100010 00110110 00111110 00110110 ;7
	.quat	00011100 00011100 00011100 00011100 00000000 00010100 00011100 00010100 ;8
	.quat	00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 ;9
	;    	[..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..]
	.quat	000111000000 000011100000 000001110000 000000111000 000111000000 000011100000 000001110000 000000111000 ;1
	.quat	001111100000 000111110000 000011111000 000001111100 001111100000 000111110000 000011111000 000001111100 ;2
	.quat	000011110000 001111111000 000111111100 000011111110 011110000000 001111111000 000111111100 000011111110 ;3
	.quat	000001110000 000001111000 000111111100 000000011110 011100000000 001111000000 000111111100 000011110000 ;4
	.quat	000011110000 001111111000 000111111100 000011111110 011110000000 001111111000 000111111100 000011111110 ;5
	.quat	001111100000 000111110000 000011111000 000001111100 001111100000 000111110000 000011111000 000001111100 ;6
	.quat	000111000000 000011100000 000001110000 000000111000 000111000000 000011100000 000001110000 000000111000 ;7

_mrbluebits
	;    	[..][..] [..][..] [..][..] [..][..] [..][..] [..][..] [..][..] [..][..]
	.quat	00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 ;2
	.quat	00000000 00020200 00022200 00020200 00022200 00022200 00022200 00022200 ;2
	.quat	00200020 00220220 00222220 00220220 00222220 00222220 00222220 00222220 ;3
	.quat	02200022 02220222 02222222 02220222 02222222 02222222 02222222 02222222 ;4
	.quat	02220222 02222222 02222222 02222222 02220222 02222222 02222222 02222222 ;5
	.quat	02222222 02222222 02222222 02222222 02200022 02220222 02222222 02220222 ;6
	.quat	00222220 00222220 00222220 00222220 00200020 00220220 00222220 00220220 ;7
	.quat	00022200 00022200 00022200 00022200 00000000 00020200 00022200 00020200 ;8
	.quat	00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 ;9
	;    	[..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..]
	.quat	000222000000 000022200000 000002220000 000000222000 000222000000 000022200000 000002220000 000000222000 ;2
	.quat	002222200000 000222220000 000022222000 000002222200 002222200000 000222220000 000022222000 000002222200 ;2
	.quat	000022220000 002222222000 000222222200 000022222220 022220000000 002222222000 000222222200 000022222220 ;3
	.quat	000002220000 000002222000 000222222200 000000022220 022200000000 002222000000 000222222200 000022220000 ;4
	.quat	000022220000 002222222000 000222222200 000022222220 022220000000 002222222000 000222222200 000022222220 ;5
	.quat	002222200000 000222220000 000022222000 000002222200 002222200000 000222220000 000022222000 000002222200 ;6
	.quat	000222000000 000022200000 000002220000 000000222000 000222000000 000022200000 000002220000 000000222000 ;7

_mspacmask
	;    	[..][..] [..][..] [..][..] [..][..] [..][..] [..][..] [..][..] [..][..]
	.quat	33333333 33333333 33333333 33333333 33300003 33000003 33300003 33300003 ;1
	.quat	33300033 33300033 33300033 33300033 33000000 30000000 33000000 33000000 ;2
	.quat	33000003 33000003 33000003 33000003 30000000 30000000 30000000 30000000 ;3
	.quat	30000000 30000000 30000000 30000000 30000000 30000000 30000000 30000000 ;4
	.quat	30000000 30000000 30000000 30000000 30000000 30000000 30000000 30000000 ;5
	.quat	30000000 30000000 30000000 30000000 30000000 30000000 30000000 30000000 ;6
	.quat	30000000 30000000 30000000 30000000 33000003 33000003 33000003 33000003 ;7
	.quat	30000003 30000003 30000003 30000003 33300033 33300033 33300033 33300033 ;8
	.quat	33000033 33000033 33000033 33000033 33333333 33333333 33333333 33333333 ;9
	;    	[..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..]
	.quat	333000003333 333300000333 333330000033 333333000003 300000333333 330000033333 333000003333 333300000333 ;1
	.quat	330000000333 333000000033 333300000003 333330000000 000000033333 300000003333 330000000333 333000000033 ;2
	.quat	300000000333 330000000033 333000000003 333300000000 000000003333 300000000333 330000000033 333000000003 ;3
	.quat	300000000333 330000000033 333000000003 333300000000 000000003333 300000000333 330000000033 333000000003 ;4
	.quat	300000000333 330000000033 333000000003 333300000000 000000003333 300000000333 330000000033 333000000003 ;5
	.quat	330000003333 333000000333 333300000033 333330000003 300000033333 300000003333 333000000333 333300000033 ;6
	.quat	333000033333 333300003333 333330000333 333333000033 330000333333 330000033333 333300003333 333330000333 ;7

_mspacbits
	;    	[..][..] [..][..] [..][..] [..][..] [..][..] [..][..] [..][..] [..][..]
	.quat	00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 ;1
	.quat	00000000 00030300 00030300 00030300 00011130 00011130 00011130 00011130 ;2
	.quat	00300030 00110110 00113110 00110110 00111113 00111113 00111113 00111113 ;3
	.quat	01100011 01110111 01111111 01110111 01111111 01111111 01111111 01111111 ;4
	.quat	01110111 01111111 01111111 01111111 01110111 01111111 01111111 01111111 ;5
	.quat	01111111 01111111 01111111 01111111 01100011 01110111 01111111 01110111 ;6
	.quat	03111110 03111110 03111110 03111110 00300030 00110110 00113110 00110110 ;7
	.quat	00311100 00311100 00311100 00311100 00000000 00030300 00030300 00030300 ;8
	.quat	00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 ;9
	;    	[..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..]
	.quat	000111300000 000011130000 000001113000 000000111300 003111000000 000311100000 000031110000 000003111000 ;1
	.quat	003111130000 000111113000 000011111300 000001111130 031111300000 003111110000 000311111000 000031111100 ;2
	.quat	000011110000 003111111000 000311111100 000031111110 011110000000 001111113000 000111111300 000011111130 ;3
	.quat	000001110000 000001111000 000031111100 000000011110 011100000000 001111000000 000111113000 000011110000 ;4
	.quat	000011110000 003111111000 000311111100 000031111110 011110000000 001111113000 000111111300 000011111130 ;5
	.quat	003111100000 000111110000 000011111000 000001111100 001111300000 000111110000 000011111000 000001111100 ;6
	.quat	000111000000 000011100000 000001110000 000000111000 000111000000 000011100000 000001110000 000000111000 ;7

;_msbluebits
	;    	[..][..] [..][..] [..][..] [..][..] [..][..] [..][..] [..][..] [..][..]
	.quat	00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 ;1
	.quat	00000000 00030300 00030300 00030300 00022300 00022300 00022300 00022300 ;2
	.quat	00300030 00220220 00222220 00220220 00222230 00222230 00222230 00222230 ;3
	.quat	02200022 02220222 02222222 02220222 02222222 02222222 02222222 02222222 ;4
	.quat	02220222 02222222 02222222 02222222 02220222 02222222 02222222 02222222 ;5
	.quat	02222222 02222222 02222222 02222222 02200022 02220222 02222222 02220222 ;6
	.quat	00322220 00322220 00322220 00322220 00300030 00220220 00222220 00220220 ;7
	.quat	00032200 00032200 00032200 00032200 00000000 00030300 00030300 00030300 ;8
	.quat	00000000 00000000 00000000 00000000 00000000 00000000 00000000 00000000 ;9
	;    	[..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..] [..][..][..]
	.quat	000222000000 000022200000 000002220000 000000222000 000222000000 000022200000 000002220000 000000222000 ;1
	.quat	003222300000 000222230000 000022222000 000002222300 003222300000 000322220000 000032222000 000003222200 ;2
	.quat	000022230000 003222223000 000322222200 000032222230 032220000000 003222223000 000322222300 000032222230 ;3
	.quat	000002220000 000002222000 000022222200 000000022220 022200000000 002222000000 000222222000 000022220000 ;4
	.quat	000022220000 003222222000 000322222200 000032222220 022220000000 002222223000 000222222300 000022222230 ;5
	.quat	003222200000 000222220000 000022222000 000002222200 002222300000 000222220000 000022222000 000002222200 ;6
	.quat	000222000000 000022200000 000002220000 000000222000 000222000000 000022200000 000002220000 000000222000 ;7

deadpac	.quat	00011100
	.quat	00111110
	.quat	01111111
	.quat	01111111
	.quat	01111111
	.quat	00111110
	.quat	00011100

	.quat	00010100
	.quat	00110110
	.quat	01110111
	.quat	01111111
	.quat	01111111
	.quat	00111110
	.quat	00011100

	.quat	00000000
	.quat	00100010
	.quat	01110111
	.quat	01111111
	.quat	01111111
	.quat	00111110
	.quat	00011100

	.quat	00000000
	.quat	00000000
	.quat	01100011
	.quat	01110111
	.quat	01111111
	.quat	00111110
	.quat	00011100

	.quat	00000000
	.quat	00000000
	.quat	01000001
	.quat	01110111
	.quat	01111111
	.quat	00111110
	.quat	00011100

	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	01100011
	.quat	01111111
	.quat	00111110
	.quat	00011100

	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00111110
	.quat	00111110
	.quat	00011100

	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00011100
	.quat	00111110
	.quat	00011100

	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00001000
	.quat	00111110
	.quat	00011100

	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00001000
	.quat	00011100
	.quat	00011100

	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00001000
	.quat	00001000
	.quat	00011100

	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00001000
	.quat	00001000
	.quat	00001000

	.quat	00001000
	.quat	00100010
	.quat	00010100
	.quat	01000001
	.quat	00010100
	.quat	00100010
	.quat	00001000

	.quat	00001000
	.quat	00100010
	.quat	00000000
	.quat	01000001
	.quat	00000000
	.quat	00100010
	.quat	00001000

	.quat	00000000
	.quat	00100010
	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00100010
	.quat	00000000

	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00000000
	.quat	00000000

offsts1	.word	$FF00, $0100, $00FF, $0001
offsts4	.word	$FC00, $0400, $00FC, $0004
offstsp	.word	$FF00, $0400, $00FF, $0004
offsts8	.word	$F800, $0800, $00F8, $0008
offstsg	.word	$F000, $1000, $00F0, $0010

;ENTRY		MODIFIES
; A dir		whoscn whorow tmpcnt
; B who		whomsk whocol tmpst1
; X row,col	wholoc whodir tmpst2

drawmrp
	ldx	pacrow
	ldaa	pacdir
	bra	drawwho
drawmsp
	ldx	msprow
	pshx
	stx	whorow
	ldaa	mspdir
	staa	whodir
	ldx	#_mspacmask
	stx	whomsk
	ldx	#_mspacbits
	pshb
	psha
	bra	_drwh2

drawmrb
	ldx	pacrow
	pshx
	stx	whorow
	ldaa	pacdir
	staa	whodir
	ldx	#_mrpacmask
	stx	whomsk
	ldx	#_mrbluebits
	pshb
	psha
	bra	_drwh2


drawwho
	pshx
	pshb
	psha
	stx	whorow		; save row,col
	staa	whodir		; save dir
	ldx	#_mrpacmask	; get mask
	stx	whomsk
	ldx	#_mrpacbits	; get pacmen
_drwh2	stx	wholoc
	ldaa	whodir		; get dir
	bita	#$02		; test up/dn
	bne	_drhorz		; go if left or right
	ldab	whorow		; find rowoffset
	andb	#$03		;
	lsla			;
	lsla			;
	lsld			;
	aba			;
	tab			; b = 2*(4*up+rowoff)
	ldx	whomsk		; adjust mask and loc pointers by offset
	abx
	stx	whomsk
	ldx	wholoc
	abx
	stx	wholoc
	ldd	whorow		; get scnloc
	jsr	rc2scn
	std	whoscn
	ldd	#$0910
	staa	tmpcnt		; =9 rows to write
	stab	tmpst1		; =  of width 16.
	bsr	_drwch2		; draw them
	pula
	pulb
	pulx
	rts
_drhorz	anda	#$01		; 1=rt 0=left
	lsla			; 2=rt 0=left
	lsla			; 4=rt 0=left
	ldab	whocol		;
	andb	#$03		;
	aba			;
	ldab	#$03		;
	mul			;
	addb	#$90		; b=3*(4*rt+coloff)+$90
	ldx	wholoc		;
	abx			;
	pshx			; psh corrected wholoc
	stx	wholoc		;
	ldx	whomsk		;
	abx			;
	pshx			; psh corrected whomsk
	stx	whomsk		;
	ldd	whorow		; bump row and get col
	inca
	jsr	rc2scn		; get corresponding screen loc
	std	whoscn
	pshb			; psh screenloc
	psha
	ldaa	#$07		; 7 rows to write
	staa	tmpcnt
	ldaa	#$18		; of width 24.
	staa	tmpst1
	ldab	whocol
	cmpb	#$6C		; check if in tunnel
	bhi	_drawintunnel
	bsr	_drwch2		; draw first two columns
	ldd	#$0702		; 7 rows to write, offset of 2
	staa	tmpcnt
	pulx			; pull screenloc
	abx			; +2
	stx	whoscn		; store it
_drtn3a	pulx			; pull whomsk
	abx			; +2
	stx	whomsk		; store it
	pulx			; pull wholoc
	abx			; +2
	stx	wholoc		; store it
	bra	_drwch1		; draw last column and leave

_drwch2	ldx	whoscn
	ldd	,x
	ldx	whomsk
	anda	0,x
	andb	1,x
	ldx	wholoc
	oraa	0,x
	orab	1,x
	ldx	whoscn
	std	,x
	ldab	#$20
	abx
	stx	whoscn
	ldab	tmpst1
	ldx	wholoc
	abx
	stx	wholoc
	ldx	whomsk
	abx
	stx	whomsk
	dec	tmpcnt
	bne	_drwch2
	rts

_drwch1	ldx	whoscn
	ldaa	,x
	ldx	whomsk
	anda	,x
	ldx	wholoc
	oraa	,x
	ldx	whoscn
	staa	,x
	ldab	#$20
	abx
	stx	whoscn
	ldab	tmpst1
	ldx	wholoc
	abx
	stx	wholoc
	ldx	whomsk
	abx
	stx	whomsk
	dec	 tmpcnt
	bne	 _drwch1
	pula
	pulb
	pulx
	rts

_drtnn3	pulx			; pull screenloc
	ldx	#$45A0
	stx	whoscn
	cmpb	#$78
	blo	_drtnn5
	subb	#$7C
	bhs	_drtnn4
	ldab	#$02
	bra	_drtn3a

_drawintunnel
	cmpb	#$70
	bhs	_drtnn2
	pulx
	pulx
	pulx
_drtn4a	bsr	_drwch2
	pula
	pulb
	pulx
	rts

_drtnn2	cmpb	#$74
	bhs	_drtnn3
	pulx
	pulx
	pulx
	bra	_drwch1

_drtnn4	pulx			; pull whomsk
	inx
	stx	whomsk
	pulx			; pull wholoc
	inx
	stx	wholoc
	bra	_drtn4a
_drtnn5	pulx
	pulx
	pula
	pulb
	pulx
	rts

_islegal
	stx	whorow
	bsr	applyd
	bsr	_tstmzval
	bmi	_lglrts
	bitb	#$03
	beq	_try1
	addb	#$04
	bsr	_tstmzval
	bmi	_lglrts
_try1	bita	#$03
	beq	_try2
	adda	#$04
	bsr	_tstmzval
	bmi	_lglrts
_try2	bita	#$03
	beq	_lglrts
	bitb	#$03
	beq	_lglrts
	subb	#$04
	bsr	_tstmzval
	bmi	_lglrts
	clra
_lglrts	rts


_tstmzval
	andb	#$7F
	pshb
	psha
	bsr	rc2maz
	pshb
	psha
	pulx
	tst	,x
	pula
	pulb
	rts

applyd
	ldx	#offsts1
	bra	_appl1
applyd4
	ldx	#offsts4
_appl1
	tab
	andb	#$03
	lslb
	abx
	ldd	whorow
	adda	0,x
	addb	1,x
	andb	#$7F
	std	whorow
	rts

rc2scn
	lslb
	lsrd
	lsrd
	lsrd
	adda	#$41
	rts

rc2maz	adda	#$04
	lsra
	lsra
	lslb
	lsrd
	lsrd
	lsrd
	adda	#$4C
	rts

rc2mazx	pshb
	psha
	bsr	rc2maz
	pshb
	psha
	pulx
	pula
	pulb
	rts

_ckmsk	staa	tmpcnt
	ldd	pacrow
	jsr	rc2mazx
	ldaa	,x
	bita	tmpcnt		; check for pellet/ghost
	bne	_mskrts		; found one
	ldaa	pacrow
	bita	#$03		; check down?
	beq	_checkr		; nope, try right...
	adda	#$04		;
_checkp	jsr	rc2mazx		; get x
	ldaa	,x		; get a
	bmi	_cklvl		; leave if border
	bita	tmpcnt		; check for pellet/ghost
	rts
_checkr	addb	#$04
	bitb	#$03		; check right?
	bne	_checkp		; go if we should
_cklvl	bita	#$00
_mskrts	rts

_dopell	ldaa #$C0
	staa	sndval
	ldaa	,x
	anda	#$BF
	staa	,x
	cpx	#$4DAD		; ate a fruit?
	bne	_ckpill
	ldd	sndfrt
	std	sndloc
	ldd	frtval		; get fruit value
	jsr	sshowc
	ldd	frtval
	jsr	splusd
	clr	cntfrt		; get rid of fruit
	dec	cntglt		; gloat over score
	jsr	fclear
	jmp	_drwpac
_ckpill	jsr	pwpillq		; ate a power pill?
	beq	_clritm		; yes, clear item
	ldd	#$0020
	jsr	splusd
	ldd	#fspellet
	std	sndloc
_clritm	ldx	cntmr1		; slow down the pac
	ldab	#$40
	abx
	stx	cntmr1
	ldaa	pltlft		; decrement number of items to eat
	deca
	beq	_allgone
	staa	pltlft
	cmpa	#$20
	beq	_enbfrt
	cmpa	#$60
	bne	_drpac
_enbfrt	dec	cntfrt		; enable the fruit
_drpac	jmp	_drwpac

_allgone
	pulx
	ldx	pacrow
	stx	whorow
	ldd	pacdir
	jsr	drawwho
	ldd	pacdir
	jsr	applyd
	ldx	whorow
	stx	pacrow
	ldd	pacdir
	jsr	drawwho
	ldaa	#$06
	jsr	gdelay
	jsr	mredraw
	ldx	pacrow
	ldd	pacdir
	jsr	drawwho
	bsr	_flashme
	jmp	newlevel

_flashme
	bsr	_flash1
_flash1	bsr	_flash2
_flash2	ldaa	#$01
	jsr	gdelay
	ldaa	#$64
	staa	$BFFF
	ldaa	#$01
	jsr	gdelay
	ldaa	#$24
	staa	$BFFF
	rts
gomrpac
	tst	gameon
	bne	_ckeat
	jsr	wgameover
_ckeat	ldaa	eatcnt		; check if eating
	beq	_ckcrnr
	deca
	staa	eatcnt
	bne	_ckflsh
	jsr	gmknrm
	bra	_cpell
_ckflsh	cmpa	#$40
	bhi	_cpell
	bita	#$07
	bne	_cpell
	jsr	gflash
	bra	_cpell
_ckcrnr	tst	cntcnr		; reverse monsters?
	beq	_akdtct
	dec	cntcnr
	bne	_cpell
	jsr	gallrev
_akdtct	ldx	cntatk
	inx
	stx	cntatk
	cpx	#$0100
	beq	_akpac
	cpx	#$0500
	bne	_cpell
_akpac	ldaa	#$FF
	staa	cntcnr
	jsr	gallrev
_cpell	ldaa	#$40		; pac collides with pellet
	jsr	_ckmsk
	beq	_cghst
	jmp	_dopell
_cghst	ldaa	#$0F		; pac collides with ghost
	jsr	_ckmsk
	beq	_donecl
	jsr	gtagged
_donecl	jsr	gpenck		; let them monsters loose!
	ldaa	cntfrt		; should we draw the fruit?
	beq	_gloatck	; nope..
	deca
	staa	cntfrt
	beq	_clrfrt		; yup.
	jsr	fdraw
	bra	_drwpac
_clrfrt	jsr	fclear
_drwpac	ldx	pacrow
	ldaa	pacdir
	jsr	drawwho
	jsr	mrkey		; try key
	bne	_coast		; go if failed
	ldx	pacrow		; test key
	ldaa	keydir		;
	jsr	_islegal	;
	bne	_coast		;
	ldaa	keydir		; change direction
	staa	pacdir		;
_coast	ldx	pacrow		;
	ldaa	pacdir		;
	jsr	_islegal	;
	bne	_done		;
	ldd	pacrow
	bsr	_clrpac
	ldx	whorow
	stx	pacrow
	ldd	whorow
	bsr	_setpac
	;pwrcrnr
	jsr	mrky
	bne	_done
	ldx	pacrow
	stx	whorow
	ldaa	pacdir
	eora	keydir
	bita	#$02		; leave if same or reverse direction
	beq	_done
	ldaa	pacdir
	jsr	applyd
	ldx	whorow
	ldaa	keydir
	jsr	_islegal
	bne	_done
	ldaa	#$02
	staa	paccrn
_done	rts

_clrpac
	jsr	rc2mazx
	ldaa	,x
	anda	#$DF
	staa	,x
	rts

_setpac
	jsr	rc2mazx
	ldaa	,x
	oraa	#$20
	staa	,x
	rts

_gloatck
	ldaa	cntglt
	beq	_drwpac
	deca
	staa	cntglt
	beq	_clearf
	ldd	frtval
	jsr	sshowc
	jmp	_drwpac
_clearf	jsr	sclrc
	jmp	_drwpac

autopilot
	ldd	whorow
	anda	#$FC
	andb	#$FC
	std	whorow
	ldx	#ghost2
	ldaa	$05,x
	cmpa	#$01
	beq	_runaway
	ldx	$02,x
	stx	tmpst1
_autogo	jsr	gtarget
	lsra
	lsra
	anda	#$03
	staa	keydir
	bita	#$00
	rts
_runaway
	ldd	whorow
	lsla
	lslb
	suba	$02,x
	subb	$03,x
	std	tmpst1
	bra	_autogo

killmsk	ldd	$00,x
	lsld
	addd	$00,x
	coma
	comb
	std	mn03

	ldd	$02,x
	lsld
	addd	$02,x
	coma
	comb
	std	mn13

	ldd	$04,x
	lsld
	addd	$04,x
	coma
	comb
	std	mn23

	ldd	$06,x
	lsld
	addd	$06,x
	coma
	comb
	std	mn33

	ldd	$08,x
	lsld
	addd	$08,x
	coma
	comb
	std	mn43

	ldd	$0A,x
	lsld
	addd	$0A,x
	coma
	comb
	std	mn53

	ldd	$0C,x
	lsld
	addd	$0C,x
	coma
	comb
	std	mn63

	ldaa	#$FF
	staa	mn05
	staa	mn15
	staa	mn25
	staa	mn35
	staa	mn45
	staa	mn55
	staa	mn65
	ldab	paccol
_kmsk1	andb	#$03
	beq	_kmskrt
	bsr	_kmsk2
	decb
	bra	_kmsk1
_kmsk2	bsr	_kill2
_kill2	sec
	ror	mn03
	ror	mn04
	ror	mn05
	ror	mn13
	ror	mn14
	ror	mn15
	ror	mn23
	ror	mn24
	ror	mn25
	ror	mn33
	ror	mn34
	ror	mn35
	ror	mn43
	ror	mn44
	ror	mn45
	ror	mn53
	ror	mn54
	ror	mn55
	ror	mn63
	ror	mn64
	ror	mn65
_kmskrt	rts

killpac	ldd	pacrow
	jsr	rc2scn
	std	wholoc
	ldaa	#$80
	staa	sndval
	ldx	#deadpac
	jsr	killmsk		; set up mask
_killp1	bsr	_kpc1
	stx	tmpst1
	jsr	_kdrws
	ldab	#$0E
	ldx	tmpst1
	abx
	cpx	#offsts1
	bne	_killp1
	rts

killbpc	ldd	$00,x
	lsld
	std	mn00
	ldd	$02,x
	lsld
	std	mn10
	ldd	$04,x
	lsld
	std	mn20
	ldd	$06,x
	lsld
	std	mn30
	ldd	$08,x
	lsld
	std	mn40
	ldd	$0A,x
	lsld
	std	mn50
	ldd	$0C,x
	lsld
	std	mn60
	bra	_kpa

_kpc1	ldd	$00,x
	std	mn00
	ldd	$02,x
	std	mn10
	ldd	$04,x
	std	mn20
	ldd	$06,x
	std	mn30
	ldd	$08,x
	std	mn40
	ldd	$0A,x
	std	mn50
	ldd	$0C,x
	std	mn60
_kpa	clra
	staa	mn02
	staa	mn12
	staa	mn22
	staa	mn32
	staa	mn42
	staa	mn52
	staa	mn62

	ldab	paccol
_kill1	andb	#$03
	beq	_kill2r
	decb
	bsr	_kpc2
	bra	_kill1
_kpc2	bsr	_killp2
_killp2	lsr	mn00
	ror	mn01
	ror	mn02
	lsr	mn10
	ror	mn11
	ror	mn12
	lsr	mn20
	ror	mn21
	ror	mn22
	lsr	mn30
	ror	mn31
	ror	mn32
	lsr	mn40
	ror	mn41
	ror	mn42
	lsr	mn50
	ror	mn51
	ror	mn52
	lsr	mn60
	ror	mn61
	ror	mn62
_kill2r	rts

_kdrws
	ldx	wholoc
	bsr	killdrw
	ldd	tmpst1
	subd	#deadpac	; b = 2 * 7 * n
	ldaa	#$B7		; a = 1/7 mod 256 [since 183 * 7 = 1 mod 256]
	mul			; b = 2 * n
	jmp	spacdie

killdrw	ldd	mn03
	anda	$20,x
	oraa	mn00
	andb	$21,x
	orab	mn01
	std	$20,x
	ldaa	mn05
	anda	$22,x
	oraa	mn02
	staa	$22,x
	ldd	mn13
	anda	$40,x
	oraa	mn10
	andb	$41,x
	orab	mn11
	std	$40,x
	ldaa	mn15
	anda	$42,x
	oraa	mn12
	staa	$42,x
	ldd	mn23
	anda	$60,x
	oraa	mn20
	andb	$61,x
	orab	mn21
	std	$60,x
	ldaa	mn25
	anda	$62,x
	oraa	mn22
	staa	$62,x
	ldd	mn33
	anda	$80,x
	oraa	mn30
	andb	$81,x
	orab	mn31
	std	$80,x
	ldaa	mn35
	anda	$82,x
	oraa	mn32
	staa	$82,x
	ldd	mn43
	anda	$A0,x
	oraa	mn40
	andb	$A1,x
	orab	mn41
	std	$A0,x
	ldaa	mn45
	anda	$A2,x
	oraa	mn42
	staa	$A2,x
	ldd	mn53
	anda	$C0,x
	oraa	mn50
	andb	$C1,x
	orab	mn51
	std	$C0,x
	ldaa	mn55
	anda	$C2,x
	oraa	mn52
	staa	$C2,x
	ldd	mn63
	anda	$E0,x
	oraa	mn60
	andb	$E1,x
	orab	mn61
	std	$E0,x
	ldaa	mn65
	anda	$E2,x
	oraa	mn62
	staa	$E2,x
	rts
